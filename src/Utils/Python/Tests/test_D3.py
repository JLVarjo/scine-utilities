__copyright__ = """This code is licensed under the 3-clause BSD license.
Copyright ETH Zurich, Laboratory of Physical Chemistry, Reiher Group.
See LICENSE.txt for details.
"""

import pytest
import scine_utilities as scine
import os


def get_structure():
    # Write a sample XYZ file
    sample_XYZ = """111

  C   -2.04954507139919      0.49346459974284      0.19403708095030
  C   -0.68994584664293      0.24498551943875     -0.48728935738284
  H   -1.91938928475996      0.26021745455615      1.25855031165228
  C   -3.14426501541109     -0.38993518976336     -0.40317206956060
  N   -2.28685698583691      1.94767379863413      0.14878941970778
  C   -0.27951756876751     -1.22058665005177     -0.36550874084111
  N   0.24097504669724      1.23597051240999      0.07433332522267
  H   -0.79817613961669      0.50662260467413     -1.54994979799048
  C   -2.73139840250440     -1.86646507169582     -0.30459890356185
  H   -3.31426754402753     -0.11157394102816     -1.45104048488576
  H   -4.08740996064897     -0.23965147661296      0.13329358281900
  C   -1.37237236245536     -2.11751151850859     -0.96740655951936
  H   -3.50036441159888     -2.49528484810240     -0.76674625385721
  H   -2.67692478831873     -2.15416547391794      0.75385480191594
  H   -1.44921617537744     -1.91734894037221     -2.04497106436333
  H   -1.08572552070489     -3.16981456558983     -0.85948673907074
  H   -0.13020491148699     -1.46885695236768      0.69354276528090
  H   0.66954724487480     -1.39561995215723     -0.88425085333822
  C   1.46008944970184      0.98514467699238      0.39769354812489
  C   -3.45450814424032      2.47238300834947      0.00318683222481
  Mn  -0.62740577664457      3.00042723327634      0.24981138311896
  Cl  -0.77190534903661      2.27052105147490      2.55668552389363
  O   0.94717409770232      3.87889063769865      0.76949369546203
  O   -1.52528344714375      4.56769509314170      0.75501905102585
  C   -2.80783982424845      4.82121758023799      0.62748585937203
  C   -3.75986953640787      3.86533208523123      0.15328097599859
  C   -3.27985309595695      6.13034947382499      0.98003712378897
  H   -4.30569253403915      1.81943364053180     -0.19958098334289
  C   -5.09866363284808      4.24099203805007     -0.07331640048439
  C   2.40005917295061      1.94436165989897      0.90821046986723
  H   1.83433169313173     -0.03637112556795      0.29353084627507
  C   2.10873332863783      3.33656524353963      1.06263835297119
  C   3.14926484875961      4.19561876428366      1.54849799956785
  C   3.67122070870860      1.43860539002233      1.25009588091058
  C   -4.60561872832707      6.43509333741244      0.70903643281861
  C   -5.54128397814805      5.52849698547268      0.16428488535104
  H   -5.77510362299943      3.47954238775536     -0.44905000250600
  C   -2.35121862890659      7.13971712191373      1.66334132067180
  C   4.67789462558235      2.25447436615883      1.73243457296332
  H   3.83499049328653      0.37206802842858      1.12313605573798
  C   4.37783744442278      3.62666352141399      1.85690263210696
  C   2.91036151348742      5.70045562415378      1.71518016308150
  C   -6.97770079198632      5.98523048128377     -0.09496820690846
  H   -4.95298360793980      7.43475978174949      0.94473892775111
  C   6.06482570420256      1.74288253485095      2.12536886797205
  H   5.15981416390186      4.28152009200965      2.22423216944500
  C   -1.86964434010808      6.53401792490724      3.00458213575159
  C   -3.07700897782200      8.45837761840221      1.98476882685460
  C   -1.14472552625358      7.48659578913860      0.76272495082705
  C   -7.85288616769135      4.84662340177242     -0.64315267966354
  C   -6.96939516417516      7.13739693024225     -1.12404261102867
  C   -7.60570187618051      6.49103497803841      1.22364270752792
  C   2.53942859943231      6.33080408864722      0.35147003340888
  C   4.16466266696969      6.43091570602525      2.22744559397163
  C   1.78113064313056      5.93517348180064      2.74345085677705
  C   6.19671942485128      0.22517036797559      1.92600610701894
  C   6.32336504220137      2.06430527402333      3.61486155230123
  C   7.13465911933550      2.44584604839223      1.26066024918145
  H   6.97972138439825      2.22658782615567      0.19841063261595
  H   8.13569349180792      2.10027931172002      1.54390569545958
  H   7.10220740280281      3.53268524604814      1.39061845600487
  H   5.58046178985460      1.57256023594689      4.25119023000150
  H   6.27313806599647      3.14122737756939      3.80473758713604
  H   7.31944463992090      1.71420487889887      3.90912043828194
  H   5.47350076827894     -0.32542835885976      2.53706657152166
  H   7.20027372099028     -0.09675294866989      2.22286828336657
  H   6.05121988503054     -0.05673782942222      0.87712347748801
  H   5.00924700842936      6.33263766517312      1.53500724397903
  H   4.47493587876587      6.06881270407874      3.21386341792396
  H   3.93409070743025      7.49735523722311      2.32222584505330
  H   0.85813947996631      5.44810386681995      2.43598675708472
  H   1.59611883205988      7.01099863310485      2.84637518583010
  H   2.07276768245146      5.54167647700564      3.72354895445304
  H   3.36199034147681      6.20328953933432     -0.36221504683867
  H   2.36102275862487      7.40462201899642      0.48112838840598
  H   1.64107671634069      5.87516839522832     -0.06465639765120
  H   -2.72345829093801      6.37564505895787      3.67281663577421
  H   -1.17497582928836      7.22765079366384      3.49299588383011
  H   -1.36541900120089      5.57845911921942      2.85572229502848
  H   -3.93417751366491      8.30219801250051      2.64964406646150
  H   -3.42467357855893      8.96643772449778      1.07761713364915
  H   -2.37660789413876      9.12854033136797      2.49452668299751
  H   -0.56571588586585      6.59930345991454      0.51346683103427
  H   -0.49297490713285      8.19630170799128      1.28536746599081
  H   -1.48722927395676      7.96049735492584     -0.16382389702834
  H   -7.45451709864170      4.45016084269664     -1.58238236773522
  H   -8.86353654253283      5.22204729253269     -0.83421954841187
  H   -7.93162796674867      4.02120514252091      0.07341081374228
  H   -7.62254073277562      5.69322442060897      1.97391298026946
  H   -8.63498784699360      6.82324002028751      1.04666047722293
  H   -7.04446420275119      7.33487223782684      1.63726927115536
  H   -6.55437340053619      6.79989802962478     -2.07878381014698
  H   -6.36578076522199      7.98042136264129     -0.77301152619500
  H   -7.99003809968693      7.49691091696790     -1.29796440932058
  O   -0.58117457718709      3.14840635123511     -1.32876522814175
  C   -3.65465162911951      5.55158682325514     -3.03287591760466
  C   -2.45911998087859      5.88136721211899     -2.52777694945093
  C   -4.12013021748694      4.20307019079305     -3.37124888790066
  H   -4.38457193862791      6.34299186426688     -3.20134425367596
  H   -1.68960292441784      5.14717912921101     -2.30841396123747
  H   -2.22132572604776      6.91415426531028     -2.29632480920601
  C   -3.28423624804405      3.07272920174484     -3.32336077727346
  C   -5.45944839094449      4.01776250494701     -3.75157175786376
  C   -3.77984832806600      1.81217555301830     -3.63833651476025
  H   -2.24431275101592      3.18161412634414     -3.03321908971706
  C   -5.11887185642819      1.64094202344557     -4.00025880467642
  H   -3.11246484386345      0.95425091922413     -3.61091891825824
  C   -5.95851314964250      2.75334759601635     -4.05598131498691
  H   -6.11541919341662      4.88341492242030     -3.80340449371217
  H   -5.49899366110141      0.65353364283191     -4.24642233726737
  H   -7.00028167101145      2.63804155947607     -4.34247362306615"""

    # Test reading an XYZ file
    with open("sample.xyz", "w") as xyz_file:
        xyz_file.write(sample_XYZ)

    (xyz_atoms, _) = scine.io.read("sample.xyz")

    # Clean up
    os.remove("sample.xyz")
    return xyz_atoms


def test_bp86_d3_0_energy():
    structure = get_structure()
    d3Eval = scine.D3Evaluator()
    d3Eval.calculate(structure, 1.0, 1.683, 1.139, 14.0, scine.Damping.Zero)
    energy = d3Eval.get_energy()
    assert energy == pytest.approx(-0.19527281, abs=1E-6)

def test_bp86_d3_bj_energy():
    structure = get_structure()
    d3Eval = scine.D3Evaluator()
    d3Eval.calculate(structure, 1.0, 3.2822, 0.3946, 4.8516, scine.Damping.BJ)
    energy = d3Eval.get_energy()
    assert energy == pytest.approx(-0.28100110, abs=1E-6)

def test_pbe_d3_0_energy():
    structure = get_structure()
    d3Eval = scine.D3Evaluator()
    d3Eval.calculate(structure, 1.0, 0.722, 1.217, 14.0, scine.Damping.Zero)
    energy = d3Eval.get_energy()
    assert energy == pytest.approx(-0.10692234, abs=1E-6)

def test_pbe_d3_bj_energy():
    structure = get_structure()
    d3Eval = scine.D3Evaluator()
    d3Eval.calculate(structure, 1.0, 0.7875, 0.4289, 4.4407, scine.Damping.BJ)
    energy = d3Eval.get_energy()
    assert energy == pytest.approx(-0.17744192, abs=1E-6)

def test_bp86_d3_0_gradients():
    structure = get_structure()
    d3Eval = scine.D3Evaluator()
    d3Eval.calculate(structure, 1.0, 1.683, 1.139, 14.0, scine.Damping.Zero)
    grad = d3Eval.get_gradients()
    assert grad[0, 0] == pytest.approx(-0.23939648114107E-03, abs=1E-6)
    assert grad[0, 1] == pytest.approx(-0.29326368463196E-03, abs=1E-6)
    assert grad[0, 2] == pytest.approx(0.16643267153564E-03, abs=1E-6)
    assert grad[1, 0] == pytest.approx(0.28480927202525E-03, abs=1E-6)
    assert grad[1, 1] == pytest.approx(-0.66020038784406E-03, abs=1E-6)
    assert grad[1, 2] == pytest.approx(0.38634083205742E-04, abs=1E-6)
    assert grad[2, 0] == pytest.approx(-0.55805381243386E-04, abs=1E-6)
    assert grad[2, 1] == pytest.approx(-0.14769958781335E-03, abs=1E-6)
    assert grad[2, 2] == pytest.approx(0.43079324928880E-03, abs=1E-6)
    assert grad[3, 0] == pytest.approx(-0.10159865831420E-03, abs=1E-6)
    assert grad[3, 1] == pytest.approx(-0.24115292587994E-03, abs=1E-6)
    assert grad[3, 2] == pytest.approx(0.39270485334179E-03, abs=1E-6)
    assert grad[4, 0] == pytest.approx(0.64648503102299E-03, abs=1E-6)
    assert grad[4, 1] == pytest.approx(0.11014200526491E-03, abs=1E-6)
    assert grad[4, 2] == pytest.approx(0.77315756624325E-03, abs=1E-6)
    assert grad[5, 0] == pytest.approx(0.15600742018761E-03, abs=1E-6)
    assert grad[5, 1] == pytest.approx(-0.83701252002179E-04, abs=1E-6)
    assert grad[5, 2] == pytest.approx(-0.10320055086246E-03, abs=1E-6)
    assert grad[6, 0] == pytest.approx(-0.26369629280981E-03, abs=1E-6)
    assert grad[6, 1] == pytest.approx(0.43056225680949E-03, abs=1E-6)
    assert grad[6, 2] == pytest.approx(0.25897355496868E-03, abs=1E-6)
    assert grad[7, 0] == pytest.approx(0.23727668340770E-03, abs=1E-6)
    assert grad[7, 1] == pytest.approx(-0.71058464700238E-03, abs=1E-6)
    assert grad[7, 2] == pytest.approx(-0.22975462470042E-03, abs=1E-6)
    assert grad[8, 0] == pytest.approx(0.51233163024399E-04, abs=1E-6)
    assert grad[8, 1] == pytest.approx(-0.20086917537838E-03, abs=1E-6)
    assert grad[8, 2] == pytest.approx(-0.10567080208689E-03, abs=1E-6)
    assert grad[9, 0] == pytest.approx(-0.25335844672692E-03, abs=1E-6)
    assert grad[9, 1] == pytest.approx(-0.51486210410658E-03, abs=1E-6)
    assert grad[9, 2] == pytest.approx(0.11292206538659E-03, abs=1E-6)
    assert grad[10, 0] == pytest.approx(-0.16750617929842E-03, abs=1E-6)
    assert grad[10, 1] == pytest.approx(-0.13617186678462E-03, abs=1E-6)
    assert grad[10, 2] == pytest.approx(0.65781593998751E-04, abs=1E-6)
    assert grad[11, 0] == pytest.approx(-0.64870113385215E-04, abs=1E-6)
    assert grad[11, 1] == pytest.approx(-0.18880389933317E-03, abs=1E-6)
    assert grad[11, 2] == pytest.approx(0.12669866738940E-03, abs=1E-6)
    assert grad[12, 0] == pytest.approx(-0.41101498125640E-04, abs=1E-6)
    assert grad[12, 1] == pytest.approx(-0.91089636774285E-04, abs=1E-6)
    assert grad[12, 2] == pytest.approx(-0.41780393924603E-05, abs=1E-6)
    assert grad[13, 0] == pytest.approx(-0.21937055610206E-03, abs=1E-6)
    assert grad[13, 1] == pytest.approx(-0.21022567376362E-03, abs=1E-6)
    assert grad[13, 2] == pytest.approx(-0.53355798116362E-04, abs=1E-6)
    assert grad[14, 0] == pytest.approx(0.12096030488783E-03, abs=1E-6)
    assert grad[14, 1] == pytest.approx(-0.33481498535850E-03, abs=1E-6)
    assert grad[14, 2] == pytest.approx(-0.20951168017895E-04, abs=1E-6)
    assert grad[15, 0] == pytest.approx(0.29819435863964E-05, abs=1E-6)
    assert grad[15, 1] == pytest.approx(-0.88856288253517E-04, abs=1E-6)
    assert grad[15, 2] == pytest.approx(-0.87371658347790E-05, abs=1E-6)
    assert grad[16, 0] == pytest.approx(0.16722652455443E-03, abs=1E-6)
    assert grad[16, 1] == pytest.approx(-0.41481076468878E-03, abs=1E-6)
    assert grad[16, 2] == pytest.approx(-0.69862591390206E-04, abs=1E-6)
    assert grad[17, 0] == pytest.approx(0.10772916885965E-03, abs=1E-6)
    assert grad[17, 1] == pytest.approx(-0.16632306472675E-03, abs=1E-6)
    assert grad[17, 2] == pytest.approx(-0.27498132784997E-04, abs=1E-6)
    assert grad[18, 0] == pytest.approx(0.67637761977715E-03, abs=1E-6)
    assert grad[18, 1] == pytest.approx(-0.21667916154471E-03, abs=1E-6)
    assert grad[18, 2] == pytest.approx(0.58562657565709E-04, abs=1E-6)
    assert grad[19, 0] == pytest.approx(-0.74736649925546E-03, abs=1E-6)
    assert grad[19, 1] == pytest.approx(-0.12040683859880E-04, abs=1E-6)
    assert grad[19, 2] == pytest.approx(0.72367216058471E-03, abs=1E-6)
    assert grad[20, 0] == pytest.approx(0.33510778156219E-03, abs=1E-6)
    assert grad[20, 1] == pytest.approx(-0.12848194374529E-02, abs=1E-6)
    assert grad[20, 2] == pytest.approx(0.65719560841665E-03, abs=1E-6)
    assert grad[21, 0] == pytest.approx(-0.51700318671666E-03, abs=1E-6)
    assert grad[21, 1] == pytest.approx(-0.12995799212020E-02, abs=1E-6)
    assert grad[21, 2] == pytest.approx(0.44596927969442E-03, abs=1E-6)
    assert grad[22, 0] == pytest.approx(0.23229288681336E-03, abs=1E-6)
    assert grad[22, 1] == pytest.approx(-0.46685255032151E-04, abs=1E-6)
    assert grad[22, 2] == pytest.approx(0.15731997236800E-03, abs=1E-6)
    assert grad[23, 0] == pytest.approx(-0.12877068374006E-03, abs=1E-6)
    assert grad[23, 1] == pytest.approx(-0.71406503902311E-04, abs=1E-6)
    assert grad[23, 2] == pytest.approx(0.45524638085392E-03, abs=1E-6)
    assert grad[24, 0] == pytest.approx(-0.79414902533742E-03, abs=1E-6)
    assert grad[24, 1] == pytest.approx(0.13031633455296E-04, abs=1E-6)
    assert grad[24, 2] == pytest.approx(0.50053818798825E-03, abs=1E-6)
    assert grad[25, 0] == pytest.approx(-0.70347565420089E-04, abs=1E-6)
    assert grad[25, 1] == pytest.approx(0.13634425309191E-03, abs=1E-6)
    assert grad[25, 2] == pytest.approx(0.99452415420100E-03, abs=1E-6)
    assert grad[26, 0] == pytest.approx(-0.11104642475317E-03, abs=1E-6)
    assert grad[26, 1] == pytest.approx(-0.46423862927161E-04, abs=1E-6)
    assert grad[26, 2] == pytest.approx(0.58987772591003E-03, abs=1E-6)
    assert grad[27, 0] == pytest.approx(-0.23657197709089E-03, abs=1E-6)
    assert grad[27, 1] == pytest.approx(-0.20104935787111E-03, abs=1E-6)
    assert grad[27, 2] == pytest.approx(0.47002007086454E-03, abs=1E-6)
    assert grad[28, 0] == pytest.approx(-0.24782242124356E-04, abs=1E-6)
    assert grad[28, 1] == pytest.approx(-0.19150823349044E-03, abs=1E-6)
    assert grad[28, 2] == pytest.approx(0.97555104070209E-03, abs=1E-6)
    assert grad[29, 0] == pytest.approx(0.12853758383436E-03, abs=1E-6)
    assert grad[29, 1] == pytest.approx(0.19637817812301E-03, abs=1E-6)
    assert grad[29, 2] == pytest.approx(-0.14691683814867E-03, abs=1E-6)
    assert grad[30, 0] == pytest.approx(0.13602991186037E-03, abs=1E-6)
    assert grad[30, 1] == pytest.approx(-0.20967995868233E-03, abs=1E-6)
    assert grad[30, 2] == pytest.approx(-0.56941257610763E-04, abs=1E-6)
    assert grad[31, 0] == pytest.approx(0.57719700391863E-03, abs=1E-6)
    assert grad[31, 1] == pytest.approx(-0.36817858906916E-03, abs=1E-6)
    assert grad[31, 2] == pytest.approx(-0.54971762179040E-05, abs=1E-6)
    assert grad[32, 0] == pytest.approx(0.46534525505210E-04, abs=1E-6)
    assert grad[32, 1] == pytest.approx(-0.92278239751090E-05, abs=1E-6)
    assert grad[32, 2] == pytest.approx(-0.94781232424354E-04, abs=1E-6)
    assert grad[33, 0] == pytest.approx(-0.17825669853133E-03, abs=1E-6)
    assert grad[33, 1] == pytest.approx(-0.74080518499352E-04, abs=1E-6)
    assert grad[33, 2] == pytest.approx(-0.15910188089558E-03, abs=1E-6)
    assert grad[34, 0] == pytest.approx(-0.49119782519775E-03, abs=1E-6)
    assert grad[34, 1] == pytest.approx(-0.54382238997521E-04, abs=1E-6)
    assert grad[34, 2] == pytest.approx(0.37033534453372E-03, abs=1E-6)
    assert grad[35, 0] == pytest.approx(-0.28727571461093E-03, abs=1E-6)
    assert grad[35, 1] == pytest.approx(0.82022566482949E-04, abs=1E-6)
    assert grad[35, 2] == pytest.approx(0.63619548621831E-03, abs=1E-6)
    assert grad[36, 0] == pytest.approx(-0.39231469999683E-03, abs=1E-6)
    assert grad[36, 1] == pytest.approx(-0.14956241246950E-03, abs=1E-6)
    assert grad[36, 2] == pytest.approx(0.57041515808173E-03, abs=1E-6)
    assert grad[37, 0] == pytest.approx(-0.70825954266066E-04, abs=1E-6)
    assert grad[37, 1] == pytest.approx(0.50026067941832E-03, abs=1E-6)
    assert grad[37, 2] == pytest.approx(0.34510037138103E-03, abs=1E-6)
    assert grad[38, 0] == pytest.approx(0.26496879921132E-04, abs=1E-6)
    assert grad[38, 1] == pytest.approx(-0.37417878566112E-04, abs=1E-6)
    assert grad[38, 2] == pytest.approx(-0.71129234809557E-05, abs=1E-6)
    assert grad[39, 0] == pytest.approx(0.83448184914835E-04, abs=1E-6)
    assert grad[39, 1] == pytest.approx(-0.22008189141890E-03, abs=1E-6)
    assert grad[39, 2] == pytest.approx(-0.24529271311915E-04, abs=1E-6)
    assert grad[40, 0] == pytest.approx(0.26708938471020E-03, abs=1E-6)
    assert grad[40, 1] == pytest.approx(-0.27072292230860E-03, abs=1E-6)
    assert grad[40, 2] == pytest.approx(0.16428038551436E-04, abs=1E-6)
    assert grad[41, 0] == pytest.approx(0.30046832671835E-03, abs=1E-6)
    assert grad[41, 1] == pytest.approx(0.39242810715911E-03, abs=1E-6)
    assert grad[41, 2] == pytest.approx(0.84546460198716E-04, abs=1E-6)
    assert grad[42, 0] == pytest.approx(-0.58858292946469E-03, abs=1E-6)
    assert grad[42, 1] == pytest.approx(0.27871026830993E-03, abs=1E-6)
    assert grad[42, 2] == pytest.approx(0.22211280085369E-03, abs=1E-6)
    assert grad[43, 0] == pytest.approx(0.56706507988895E-04, abs=1E-6)
    assert grad[43, 1] == pytest.approx(0.43582759454250E-03, abs=1E-6)
    assert grad[43, 2] == pytest.approx(0.27801828665525E-03, abs=1E-6)
    assert grad[44, 0] == pytest.approx(0.43743953900482E-03, abs=1E-6)
    assert grad[44, 1] == pytest.approx(-0.99307370325658E-04, abs=1E-6)
    assert grad[44, 2] == pytest.approx(0.13036978975765E-03, abs=1E-6)
    assert grad[45, 0] == pytest.approx(0.14668060877444E-03, abs=1E-6)
    assert grad[45, 1] == pytest.approx(0.43042983525089E-03, abs=1E-6)
    assert grad[45, 2] == pytest.approx(0.10951569870183E-03, abs=1E-6)
    assert grad[46, 0] == pytest.approx(-0.48384638486832E-03, abs=1E-6)
    assert grad[46, 1] == pytest.approx(0.54059541107157E-03, abs=1E-6)
    assert grad[46, 2] == pytest.approx(0.23151468012265E-03, abs=1E-6)
    assert grad[47, 0] == pytest.approx(-0.31897390893856E-05, abs=1E-6)
    assert grad[47, 1] == pytest.approx(-0.96230492759290E-04, abs=1E-6)
    assert grad[47, 2] == pytest.approx(-0.10438134801079E-04, abs=1E-6)
    assert grad[48, 0] == pytest.approx(-0.58833135719325E-03, abs=1E-6)
    assert grad[48, 1] == pytest.approx(0.76487599382896E-03, abs=1E-6)
    assert grad[48, 2] == pytest.approx(0.29974231333890E-03, abs=1E-6)
    assert grad[49, 0] == pytest.approx(-0.69589688100785E-04, abs=1E-6)
    assert grad[49, 1] == pytest.approx(0.61987946322691E-04, abs=1E-6)
    assert grad[49, 2] == pytest.approx(0.37754781642052E-03, abs=1E-6)
    assert grad[50, 0] == pytest.approx(-0.50042057497647E-03, abs=1E-6)
    assert grad[50, 1] == pytest.approx(0.23842094888645E-03, abs=1E-6)
    assert grad[50, 2] == pytest.approx(0.32693081986390E-03, abs=1E-6)
    assert grad[51, 0] == pytest.approx(-0.13512127477070E-03, abs=1E-6)
    assert grad[51, 1] == pytest.approx(0.37754409652096E-04, abs=1E-6)
    assert grad[51, 2] == pytest.approx(-0.10840049573994E-03, abs=1E-6)
    assert grad[52, 0] == pytest.approx(0.60883664576034E-03, abs=1E-6)
    assert grad[52, 1] == pytest.approx(0.18256601815862E-03, abs=1E-6)
    assert grad[52, 2] == pytest.approx(0.56297019445765E-04, abs=1E-6)
    assert grad[53, 0] == pytest.approx(-0.54843471478183E-04, abs=1E-6)
    assert grad[53, 1] == pytest.approx(-0.95069207015725E-04, abs=1E-6)
    assert grad[53, 2] == pytest.approx(-0.47762032804462E-04, abs=1E-6)
    assert grad[54, 0] == pytest.approx(0.10067059644245E-02, abs=1E-6)
    assert grad[54, 1] == pytest.approx(0.18882544427757E-03, abs=1E-6)
    assert grad[54, 2] == pytest.approx(0.27680643620143E-03, abs=1E-6)
    assert grad[55, 0] == pytest.approx(-0.16120892073712E-03, abs=1E-6)
    assert grad[55, 1] == pytest.approx(0.95888630818158E-04, abs=1E-6)
    assert grad[55, 2] == pytest.approx(-0.42407326790284E-04, abs=1E-6)
    assert grad[56, 0] == pytest.approx(0.16679665659103E-03, abs=1E-6)
    assert grad[56, 1] == pytest.approx(-0.85986842380693E-04, abs=1E-6)
    assert grad[56, 2] == pytest.approx(-0.52242841541106E-04, abs=1E-6)
    assert grad[57, 0] == pytest.approx(0.10502431145237E-03, abs=1E-6)
    assert grad[57, 1] == pytest.approx(-0.10873702095048E-03, abs=1E-6)
    assert grad[57, 2] == pytest.approx(0.11022059232849E-03, abs=1E-6)
    assert grad[58, 0] == pytest.approx(0.33834914873263E-03, abs=1E-6)
    assert grad[58, 1] == pytest.approx(0.25337847397295E-04, abs=1E-6)
    assert grad[58, 2] == pytest.approx(-0.13951960351985E-03, abs=1E-6)
    assert grad[59, 0] == pytest.approx(0.10146858805040E-03, abs=1E-6)
    assert grad[59, 1] == pytest.approx(-0.14292427521129E-04, abs=1E-6)
    assert grad[59, 2] == pytest.approx(-0.76567065642898E-04, abs=1E-6)
    assert grad[60, 0] == pytest.approx(0.29118452525138E-04, abs=1E-6)
    assert grad[60, 1] == pytest.approx(-0.22764740554297E-04, abs=1E-6)
    assert grad[60, 2] == pytest.approx(-0.67860490987149E-04, abs=1E-6)
    assert grad[61, 0] == pytest.approx(0.18480864065011E-03, abs=1E-6)
    assert grad[61, 1] == pytest.approx(-0.49275524140741E-04, abs=1E-6)
    assert grad[61, 2] == pytest.approx(0.31287187806142E-03, abs=1E-6)
    assert grad[62, 0] == pytest.approx(-0.15234608856936E-04, abs=1E-6)
    assert grad[62, 1] == pytest.approx(-0.44444645457712E-04, abs=1E-6)
    assert grad[62, 2] == pytest.approx(0.56313725109488E-04, abs=1E-6)
    assert grad[63, 0] == pytest.approx(0.36071929609932E-04, abs=1E-6)
    assert grad[63, 1] == pytest.approx(-0.49416717891306E-04, abs=1E-6)
    assert grad[63, 2] == pytest.approx(0.11071147927040E-03, abs=1E-6)
    assert grad[64, 0] == pytest.approx(-0.44719829563178E-05, abs=1E-6)
    assert grad[64, 1] == pytest.approx(-0.13475590901461E-03, abs=1E-6)
    assert grad[64, 2] == pytest.approx(-0.13023147443576E-03, abs=1E-6)
    assert grad[65, 0] == pytest.approx(0.74810712495518E-04, abs=1E-6)
    assert grad[65, 1] == pytest.approx(-0.39211158329040E-04, abs=1E-6)
    assert grad[65, 2] == pytest.approx(0.22470527764129E-04, abs=1E-6)
    assert grad[66, 0] == pytest.approx(-0.65821174667100E-04, abs=1E-6)
    assert grad[66, 1] == pytest.approx(-0.16453999238782E-03, abs=1E-6)
    assert grad[66, 2] == pytest.approx(0.51530018769344E-04, abs=1E-6)
    assert grad[67, 0] == pytest.approx(0.51136003864819E-04, abs=1E-6)
    assert grad[67, 1] == pytest.approx(0.47256791711954E-04, abs=1E-6)
    assert grad[67, 2] == pytest.approx(0.12159305117493E-03, abs=1E-6)
    assert grad[68, 0] == pytest.approx(0.10822290357402E-03, abs=1E-6)
    assert grad[68, 1] == pytest.approx(0.76178857280038E-04, abs=1E-6)
    assert grad[68, 2] == pytest.approx(-0.51330112084068E-04, abs=1E-6)
    assert grad[69, 0] == pytest.approx(-0.67384873979368E-04, abs=1E-6)
    assert grad[69, 1] == pytest.approx(0.85634365497184E-04, abs=1E-6)
    assert grad[69, 2] == pytest.approx(-0.27601519632602E-04, abs=1E-6)
    assert grad[70, 0] == pytest.approx(0.67297416968531E-03, abs=1E-6)
    assert grad[70, 1] == pytest.approx(0.22075467453647E-04, abs=1E-6)
    assert grad[70, 2] == pytest.approx(0.45379317113982E-03, abs=1E-6)
    assert grad[71, 0] == pytest.approx(0.60070738505901E-03, abs=1E-6)
    assert grad[71, 1] == pytest.approx(0.93614425119700E-04, abs=1E-6)
    assert grad[71, 2] == pytest.approx(0.29173525815529E-03, abs=1E-6)
    assert grad[72, 0] == pytest.approx(0.57388094216686E-04, abs=1E-6)
    assert grad[72, 1] == pytest.approx(0.24125830247974E-03, abs=1E-6)
    assert grad[72, 2] == pytest.approx(0.31489109430659E-03, abs=1E-6)
    assert grad[73, 0] == pytest.approx(0.66130579167566E-04, abs=1E-6)
    assert grad[73, 1] == pytest.approx(0.32145123257677E-03, abs=1E-6)
    assert grad[73, 2] == pytest.approx(-0.21299802482742E-03, abs=1E-6)
    assert grad[74, 0] == pytest.approx(0.44755352732545E-03, abs=1E-6)
    assert grad[74, 1] == pytest.approx(0.12274240646114E-03, abs=1E-6)
    assert grad[74, 2] == pytest.approx(-0.72619890743671E-04, abs=1E-6)
    assert grad[75, 0] == pytest.approx(0.44134258508854E-03, abs=1E-6)
    assert grad[75, 1] == pytest.approx(0.69810089287954E-04, abs=1E-6)
    assert grad[75, 2] == pytest.approx(-0.15444003602011E-03, abs=1E-6)
    assert grad[76, 0] == pytest.approx(0.50794953953515E-04, abs=1E-6)
    assert grad[76, 1] == pytest.approx(0.14954410394429E-03, abs=1E-6)
    assert grad[76, 2] == pytest.approx(0.34718765594306E-03, abs=1E-6)
    assert grad[77, 0] == pytest.approx(-0.35052846111756E-03, abs=1E-6)
    assert grad[77, 1] == pytest.approx(0.23690045086682E-03, abs=1E-6)
    assert grad[77, 2] == pytest.approx(0.24177273605188E-03, abs=1E-6)
    assert grad[78, 0] == pytest.approx(-0.36711835134182E-03, abs=1E-6)
    assert grad[78, 1] == pytest.approx(0.34368266795802E-03, abs=1E-6)
    assert grad[78, 2] == pytest.approx(0.25139286706542E-03, abs=1E-6)
    assert grad[79, 0] == pytest.approx(0.51571849619032E-05, abs=1E-6)
    assert grad[79, 1] == pytest.approx(0.10873828545275E-03, abs=1E-6)
    assert grad[79, 2] == pytest.approx(-0.63294402071644E-04, abs=1E-6)
    assert grad[80, 0] == pytest.approx(-0.72217689699263E-04, abs=1E-6)
    assert grad[80, 1] == pytest.approx(0.10434438056613E-03, abs=1E-6)
    assert grad[80, 2] == pytest.approx(0.13031658651699E-03, abs=1E-6)
    assert grad[81, 0] == pytest.approx(0.97642354659945E-04, abs=1E-6)
    assert grad[81, 1] == pytest.approx(0.40438756251961E-04, abs=1E-6)
    assert grad[81, 2] == pytest.approx(0.29140205409474E-04, abs=1E-6)
    assert grad[82, 0] == pytest.approx(-0.39200281549390E-03, abs=1E-6)
    assert grad[82, 1] == pytest.approx(0.52028337519622E-03, abs=1E-6)
    assert grad[82, 2] == pytest.approx(-0.14003851372667E-03, abs=1E-6)
    assert grad[83, 0] == pytest.approx(-0.40389620473747E-03, abs=1E-6)
    assert grad[83, 1] == pytest.approx(0.48176442571294E-03, abs=1E-6)
    assert grad[83, 2] == pytest.approx(-0.43555156834671E-04, abs=1E-6)
    assert grad[84, 0] == pytest.approx(0.22015800174970E-03, abs=1E-6)
    assert grad[84, 1] == pytest.approx(0.49579514240542E-03, abs=1E-6)
    assert grad[84, 2] == pytest.approx(0.38723138307901E-04, abs=1E-6)
    assert grad[85, 0] == pytest.approx(-0.41260096010419E-03, abs=1E-6)
    assert grad[85, 1] == pytest.approx(-0.44591984297989E-04, abs=1E-6)
    assert grad[85, 2] == pytest.approx(0.46894670785220E-03, abs=1E-6)
    assert grad[86, 0] == pytest.approx(-0.13470950532923E-03, abs=1E-6)
    assert grad[86, 1] == pytest.approx(0.34634413198267E-04, abs=1E-6)
    assert grad[86, 2] == pytest.approx(0.25743677376417E-04, abs=1E-6)
    assert grad[87, 0] == pytest.approx(-0.84230600023913E-04, abs=1E-6)
    assert grad[87, 1] == pytest.approx(-0.10641359062809E-03, abs=1E-6)
    assert grad[87, 2] == pytest.approx(-0.66771174423974E-04, abs=1E-6)
    assert grad[88, 0] == pytest.approx(-0.30776480888594E-03, abs=1E-6)
    assert grad[88, 1] == pytest.approx(0.85943994591127E-04, abs=1E-6)
    assert grad[88, 2] == pytest.approx(0.21326987237353E-03, abs=1E-6)
    assert grad[89, 0] == pytest.approx(-0.10313170019803E-03, abs=1E-6)
    assert grad[89, 1] == pytest.approx(-0.51259678857995E-05, abs=1E-6)
    assert grad[89, 2] == pytest.approx(0.74580805643801E-04, abs=1E-6)
    assert grad[90, 0] == pytest.approx(-0.54172057048804E-04, abs=1E-6)
    assert grad[90, 1] == pytest.approx(-0.35775842903383E-04, abs=1E-6)
    assert grad[90, 2] == pytest.approx(0.55319033649167E-04, abs=1E-6)
    assert grad[91, 0] == pytest.approx(-0.45070026896180E-03, abs=1E-6)
    assert grad[91, 1] == pytest.approx(0.53885543656225E-03, abs=1E-6)
    assert grad[91, 2] == pytest.approx(-0.37584689850402E-04, abs=1E-6)
    assert grad[92, 0] == pytest.approx(-0.82631849638403E-04, abs=1E-6)
    assert grad[92, 1] == pytest.approx(0.82732510070554E-04, abs=1E-6)
    assert grad[92, 2] == pytest.approx(-0.21839513125740E-05, abs=1E-6)
    assert grad[93, 0] == pytest.approx(-0.89786851591123E-04, abs=1E-6)
    assert grad[93, 1] == pytest.approx(0.80813651863136E-04, abs=1E-6)
    assert grad[93, 2] == pytest.approx(-0.68562172635354E-04, abs=1E-6)
    assert grad[94, 0] == pytest.approx(0.68781552639488E-03, abs=1E-6)
    assert grad[94, 1] == pytest.approx(0.86888375263331E-05, abs=1E-6)
    assert grad[94, 2] == pytest.approx(-0.26447104074035E-03, abs=1E-6)
    assert grad[95, 0] == pytest.approx(0.45038436516607E-03, abs=1E-6)
    assert grad[95, 1] == pytest.approx(0.23851119441798E-03, abs=1E-6)
    assert grad[95, 2] == pytest.approx(-0.12945730120987E-02, abs=1E-6)
    assert grad[96, 0] == pytest.approx(0.17754842185878E-04, abs=1E-6)
    assert grad[96, 1] == pytest.approx(0.29416639711523E-03, abs=1E-6)
    assert grad[96, 2] == pytest.approx(-0.16110265629177E-02, abs=1E-6)
    assert grad[97, 0] == pytest.approx(0.22545324749821E-04, abs=1E-6)
    assert grad[97, 1] == pytest.approx(-0.10707840976185E-03, abs=1E-6)
    assert grad[97, 2] == pytest.approx(-0.12588619104665E-02, abs=1E-6)
    assert grad[98, 0] == pytest.approx(0.13357884094037E-03, abs=1E-6)
    assert grad[98, 1] == pytest.approx(-0.86384364722966E-04, abs=1E-6)
    assert grad[98, 2] == pytest.approx(-0.56435621164196E-03, abs=1E-6)
    assert grad[99, 0] == pytest.approx(0.34254467274320E-04, abs=1E-6)
    assert grad[99, 1] == pytest.approx(0.31499585837147E-03, abs=1E-6)
    assert grad[99, 2] == pytest.approx(-0.11565146816106E-02, abs=1E-6)
    assert grad[100, 0] == pytest.approx(0.47138789630553E-04, abs=1E-6)
    assert grad[100, 1] == pytest.approx(0.21068582739932E-03, abs=1E-6)
    assert grad[100, 2] == pytest.approx(-0.70182914437991E-03, abs=1E-6)
    assert grad[101, 0] == pytest.approx(-0.48013535564164E-03, abs=1E-6)
    assert grad[101, 1] == pytest.approx(0.21506198743377E-03, abs=1E-6)
    assert grad[101, 2] == pytest.approx(-0.14399730307689E-02, abs=1E-6)
    assert grad[102, 0] == pytest.approx(0.24615961411572E-03, abs=1E-6)
    assert grad[102, 1] == pytest.approx(-0.36675005319376E-03, abs=1E-6)
    assert grad[102, 2] == pytest.approx(-0.10964148957526E-02, abs=1E-6)
    assert grad[103, 0] == pytest.approx(-0.51839241201035E-03, abs=1E-6)
    assert grad[103, 1] == pytest.approx(0.11651526428440E-03, abs=1E-6)
    assert grad[103, 2] == pytest.approx(-0.12225089197687E-02, abs=1E-6)
    assert grad[104, 0] == pytest.approx(0.18221540271894E-03, abs=1E-6)
    assert grad[104, 1] == pytest.approx(0.34605389817808E-03, abs=1E-6)
    assert grad[104, 2] == pytest.approx(-0.69304585970063E-03, abs=1E-6)
    assert grad[105, 0] == pytest.approx(-0.11607514844081E-03, abs=1E-6)
    assert grad[105, 1] == pytest.approx(0.15597637073673E-03, abs=1E-6)
    assert grad[105, 2] == pytest.approx(-0.54508449544137E-03, abs=1E-6)
    assert grad[106, 0] == pytest.approx(-0.15183279265987E-03, abs=1E-6)
    assert grad[106, 1] == pytest.approx(-0.24258823429891E-04, abs=1E-6)
    assert grad[106, 2] == pytest.approx(-0.49306848074821E-03, abs=1E-6)
    assert grad[107, 0] == pytest.approx(0.17332992366834E-03, abs=1E-6)
    assert grad[107, 1] == pytest.approx(-0.27852369391819E-03, abs=1E-6)
    assert grad[107, 2] == pytest.approx(-0.59342359501126E-03, abs=1E-6)
    assert grad[108, 0] == pytest.approx(0.21946567983676E-03, abs=1E-6)
    assert grad[108, 1] == pytest.approx(0.15628395056612E-04, abs=1E-6)
    assert grad[108, 2] == pytest.approx(-0.49867419140733E-03, abs=1E-6)
    assert grad[109, 0] == pytest.approx(-0.77168461227281E-04, abs=1E-6)
    assert grad[109, 1] == pytest.approx(-0.53417524868352E-04, abs=1E-6)
    assert grad[109, 2] == pytest.approx(-0.11996635991775E-03, abs=1E-6)
    assert grad[110, 0] == pytest.approx(-0.67202447662548E-04, abs=1E-6)
    assert grad[110, 1] == pytest.approx(-0.83858691399475E-04, abs=1E-6)
    assert grad[110, 2] == pytest.approx(-0.16068519102951E-03, abs=1E-6)

def test_bp86_d3_bj_gradients():
    structure = get_structure()
    d3Eval = scine.D3Evaluator()
    d3Eval.calculate(structure, 1.0, 3.2822, 0.3946, 4.8516, scine.Damping.BJ)
    grad = d3Eval.get_gradients()
    assert grad[0, 0] == pytest.approx(-0.44641271320771E-03, abs=1E-6)
    assert grad[0, 1] == pytest.approx(-0.34836653878647E-03, abs=1E-6)
    assert grad[0, 2] == pytest.approx(0.23794535455227E-03, abs=1E-6)
    assert grad[1, 0] == pytest.approx(0.45577469855532E-03, abs=1E-6)
    assert grad[1, 1] == pytest.approx(-0.51216118328020E-03, abs=1E-6)
    assert grad[1, 2] == pytest.approx(-0.22358523681505E-03, abs=1E-6)
    assert grad[2, 0] == pytest.approx(-0.16787504556191E-03, abs=1E-6)
    assert grad[2, 1] == pytest.approx(-0.18620322081428E-03, abs=1E-6)
    assert grad[2, 2] == pytest.approx(0.34017282987155E-03, abs=1E-6)
    assert grad[3, 0] == pytest.approx(-0.60630814302006E-03, abs=1E-6)
    assert grad[3, 1] == pytest.approx(-0.74541811578157E-03, abs=1E-6)
    assert grad[3, 2] == pytest.approx(0.16413329853933E-03, abs=1E-6)
    assert grad[4, 0] == pytest.approx(-0.26284075145145E-03, abs=1E-6)
    assert grad[4, 1] == pytest.approx(-0.89624101639072E-04, abs=1E-6)
    assert grad[4, 2] == pytest.approx(0.40298169397188E-03, abs=1E-6)
    assert grad[5, 0] == pytest.approx(0.33709084661949E-03, abs=1E-6)
    assert grad[5, 1] == pytest.approx(-0.81644805432351E-03, abs=1E-6)
    assert grad[5, 2] == pytest.approx(-0.18345467497986E-03, abs=1E-6)
    assert grad[6, 0] == pytest.approx(0.43843889981468E-03, abs=1E-6)
    assert grad[6, 1] == pytest.approx(-0.16674409600683E-03, abs=1E-6)
    assert grad[6, 2] == pytest.approx(-0.13161594754476E-03, abs=1E-6)
    assert grad[7, 0] == pytest.approx(0.24192941011567E-03, abs=1E-6)
    assert grad[7, 1] == pytest.approx(-0.16832764022001E-03, abs=1E-6)
    assert grad[7, 2] == pytest.approx(-0.30474423492655E-03, abs=1E-6)
    assert grad[8, 0] == pytest.approx(-0.34683727112197E-03, abs=1E-6)
    assert grad[8, 1] == pytest.approx(-0.71473634375525E-03, abs=1E-6)
    assert grad[8, 2] == pytest.approx(0.23349652243208E-04, abs=1E-6)
    assert grad[9, 0] == pytest.approx(-0.25045716376056E-03, abs=1E-6)
    assert grad[9, 1] == pytest.approx(-0.35481675979231E-03, abs=1E-6)
    assert grad[9, 2] == pytest.approx(-0.47783472255487E-04, abs=1E-6)
    assert grad[10, 0] == pytest.approx(-0.35809598349183E-03, abs=1E-6)
    assert grad[10, 1] == pytest.approx(-0.24140359149052E-03, abs=1E-6)
    assert grad[10, 2] == pytest.approx(0.12909347585806E-03, abs=1E-6)
    assert grad[11, 0] == pytest.approx(0.24560285483310E-04, abs=1E-6)
    assert grad[11, 1] == pytest.approx(-0.74514937647724E-03, abs=1E-6)
    assert grad[11, 2] == pytest.approx(-0.21485206615971E-03, abs=1E-6)
    assert grad[12, 0] == pytest.approx(-0.20367754473177E-03, abs=1E-6)
    assert grad[12, 1] == pytest.approx(-0.26269893634963E-03, abs=1E-6)
    assert grad[12, 2] == pytest.approx(-0.24559082119115E-04, abs=1E-6)
    assert grad[13, 0] == pytest.approx(-0.18259474524204E-03, abs=1E-6)
    assert grad[13, 1] == pytest.approx(-0.30353968247095E-03, abs=1E-6)
    assert grad[13, 2] == pytest.approx(0.14374385178206E-03, abs=1E-6)
    assert grad[14, 0] == pytest.approx(0.57658195466981E-04, abs=1E-6)
    assert grad[14, 1] == pytest.approx(-0.31249288904384E-03, abs=1E-6)
    assert grad[14, 2] == pytest.approx(-0.23357036167616E-03, abs=1E-6)
    assert grad[15, 0] == pytest.approx(0.56558654485810E-04, abs=1E-6)
    assert grad[15, 1] == pytest.approx(-0.31072153068333E-03, abs=1E-6)
    assert grad[15, 2] == pytest.approx(-0.67688361000117E-04, abs=1E-6)
    assert grad[16, 0] == pytest.approx(0.17678020442675E-03, abs=1E-6)
    assert grad[16, 1] == pytest.approx(-0.40706000522237E-03, abs=1E-6)
    assert grad[16, 2] == pytest.approx(0.11029162574860E-03, abs=1E-6)
    assert grad[17, 0] == pytest.approx(0.22897539601370E-03, abs=1E-6)
    assert grad[17, 1] == pytest.approx(-0.30429747189709E-03, abs=1E-6)
    assert grad[17, 2] == pytest.approx(-0.14996223947871E-03, abs=1E-6)
    assert grad[18, 0] == pytest.approx(0.73903797560823E-03, abs=1E-6)
    assert grad[18, 1] == pytest.approx(-0.24943995399781E-03, abs=1E-6)
    assert grad[18, 2] == pytest.approx(-0.78063010908874E-04, abs=1E-6)
    assert grad[19, 0] == pytest.approx(-0.61740474005408E-03, abs=1E-6)
    assert grad[19, 1] == pytest.approx(-0.28919030071639E-05, abs=1E-6)
    assert grad[19, 2] == pytest.approx(0.81457294885140E-03, abs=1E-6)
    assert grad[20, 0] == pytest.approx(0.34417247784298E-03, abs=1E-6)
    assert grad[20, 1] == pytest.approx(-0.61542332660393E-03, abs=1E-6)
    assert grad[20, 2] == pytest.approx(0.27938015674633E-03, abs=1E-6)
    assert grad[21, 0] == pytest.approx(-0.37474625438297E-03, abs=1E-6)
    assert grad[21, 1] == pytest.approx(-0.77615262525778E-03, abs=1E-6)
    assert grad[21, 2] == pytest.approx(0.25564030684309E-02, abs=1E-6)
    assert grad[22, 0] == pytest.approx(0.28156240010851E-03, abs=1E-6)
    assert grad[22, 1] == pytest.approx(-0.55492643569041E-04, abs=1E-6)
    assert grad[22, 2] == pytest.approx(-0.13014041559225E-03, abs=1E-6)
    assert grad[23, 0] == pytest.approx(-0.13103105018074E-03, abs=1E-6)
    assert grad[23, 1] == pytest.approx(0.27799316518425E-04, abs=1E-6)
    assert grad[23, 2] == pytest.approx(0.15646036491417E-03, abs=1E-6)
    assert grad[24, 0] == pytest.approx(-0.89193053184762E-03, abs=1E-6)
    assert grad[24, 1] == pytest.approx(-0.15967087536234E-03, abs=1E-6)
    assert grad[24, 2] == pytest.approx(0.33601158334330E-03, abs=1E-6)
    assert grad[25, 0] == pytest.approx(-0.56560909635577E-03, abs=1E-6)
    assert grad[25, 1] == pytest.approx(0.21152218527148E-03, abs=1E-6)
    assert grad[25, 2] == pytest.approx(0.97275710042093E-03, abs=1E-6)
    assert grad[26, 0] == pytest.approx(-0.18379499207937E-03, abs=1E-6)
    assert grad[26, 1] == pytest.approx(0.18940050876816E-03, abs=1E-6)
    assert grad[26, 2] == pytest.approx(0.55814736958811E-03, abs=1E-6)
    assert grad[27, 0] == pytest.approx(-0.28119703066395E-03, abs=1E-6)
    assert grad[27, 1] == pytest.approx(-0.16966670570161E-03, abs=1E-6)
    assert grad[27, 2] == pytest.approx(0.30675614303623E-03, abs=1E-6)
    assert grad[28, 0] == pytest.approx(0.94087469680944E-04, abs=1E-6)
    assert grad[28, 1] == pytest.approx(-0.16441875141781E-03, abs=1E-6)
    assert grad[28, 2] == pytest.approx(0.11479233636263E-02, abs=1E-6)
    assert grad[29, 0] == pytest.approx(0.62173835576336E-03, abs=1E-6)
    assert grad[29, 1] == pytest.approx(-0.81389700838245E-04, abs=1E-6)
    assert grad[29, 2] == pytest.approx(-0.22821199827511E-04, abs=1E-6)
    assert grad[30, 0] == pytest.approx(0.21843889733165E-03, abs=1E-6)
    assert grad[30, 1] == pytest.approx(-0.22654742282420E-03, abs=1E-6)
    assert grad[30, 2] == pytest.approx(-0.56436923651591E-04, abs=1E-6)
    assert grad[31, 0] == pytest.approx(0.68903716509116E-03, abs=1E-6)
    assert grad[31, 1] == pytest.approx(-0.58973713225538E-03, abs=1E-6)
    assert grad[31, 2] == pytest.approx(-0.72085095762718E-04, abs=1E-6)
    assert grad[32, 0] == pytest.approx(0.23521805385171E-03, abs=1E-6)
    assert grad[32, 1] == pytest.approx(0.91434535733175E-04, abs=1E-6)
    assert grad[32, 2] == pytest.approx(-0.27059342000401E-04, abs=1E-6)
    assert grad[33, 0] == pytest.approx(-0.28263706522879E-03, abs=1E-6)
    assert grad[33, 1] == pytest.approx(0.25238722703096E-04, abs=1E-6)
    assert grad[33, 2] == pytest.approx(-0.17971438080203E-03, abs=1E-6)
    assert grad[34, 0] == pytest.approx(-0.14349099763395E-03, abs=1E-6)
    assert grad[34, 1] == pytest.approx(-0.36734470046452E-03, abs=1E-6)
    assert grad[34, 2] == pytest.approx(0.33238504618144E-03, abs=1E-6)
    assert grad[35, 0] == pytest.approx(-0.39969396352155E-03, abs=1E-6)
    assert grad[35, 1] == pytest.approx(0.35905083869383E-04, abs=1E-6)
    assert grad[35, 2] == pytest.approx(0.61785762546793E-03, abs=1E-6)
    assert grad[36, 0] == pytest.approx(-0.26006224750122E-03, abs=1E-6)
    assert grad[36, 1] == pytest.approx(-0.21238714177715E-03, abs=1E-6)
    assert grad[36, 2] == pytest.approx(0.33696349787377E-03, abs=1E-6)
    assert grad[37, 0] == pytest.approx(-0.11569947728813E-03, abs=1E-6)
    assert grad[37, 1] == pytest.approx(0.53095339335688E-03, abs=1E-6)
    assert grad[37, 2] == pytest.approx(0.33858910927632E-03, abs=1E-6)
    assert grad[38, 0] == pytest.approx(0.88463938561081E-04, abs=1E-6)
    assert grad[38, 1] == pytest.approx(-0.15787530828135E-03, abs=1E-6)
    assert grad[38, 2] == pytest.approx(-0.19161632052436E-04, abs=1E-6)
    assert grad[39, 0] == pytest.approx(-0.21442293573086E-05, abs=1E-6)
    assert grad[39, 1] == pytest.approx(-0.25193569212640E-03, abs=1E-6)
    assert grad[39, 2] == pytest.approx(-0.57739268764463E-04, abs=1E-6)
    assert grad[40, 0] == pytest.approx(-0.16209776098162E-03, abs=1E-6)
    assert grad[40, 1] == pytest.approx(-0.34364021238956E-03, abs=1E-6)
    assert grad[40, 2] == pytest.approx(-0.14763058402152E-03, abs=1E-6)
    assert grad[41, 0] == pytest.approx(0.36577755480510E-03, abs=1E-6)
    assert grad[41, 1] == pytest.approx(0.39471668527540E-03, abs=1E-6)
    assert grad[41, 2] == pytest.approx(0.99053757893348E-04, abs=1E-6)
    assert grad[42, 0] == pytest.approx(-0.54886977155488E-03, abs=1E-6)
    assert grad[42, 1] == pytest.approx(0.17715312675855E-03, abs=1E-6)
    assert grad[42, 2] == pytest.approx(0.20499676161472E-03, abs=1E-6)
    assert grad[43, 0] == pytest.approx(-0.88552448494570E-04, abs=1E-6)
    assert grad[43, 1] == pytest.approx(0.24207094059259E-03, abs=1E-6)
    assert grad[43, 2] == pytest.approx(0.11389353518825E-03, abs=1E-6)
    assert grad[44, 0] == pytest.approx(0.34626618506442E-03, abs=1E-6)
    assert grad[44, 1] == pytest.approx(-0.16659339344682E-03, abs=1E-6)
    assert grad[44, 2] == pytest.approx(0.86740299578476E-04, abs=1E-6)
    assert grad[45, 0] == pytest.approx(0.16367720529031E-03, abs=1E-6)
    assert grad[45, 1] == pytest.approx(0.14800220164615E-03, abs=1E-6)
    assert grad[45, 2] == pytest.approx(0.72661276468407E-04, abs=1E-6)
    assert grad[46, 0] == pytest.approx(-0.21447756010488E-03, abs=1E-6)
    assert grad[46, 1] == pytest.approx(0.38814549380924E-03, abs=1E-6)
    assert grad[46, 2] == pytest.approx(0.76811641717841E-03, abs=1E-6)
    assert grad[47, 0] == pytest.approx(-0.43761247618718E-04, abs=1E-6)
    assert grad[47, 1] == pytest.approx(0.61632870436173E-03, abs=1E-6)
    assert grad[47, 2] == pytest.approx(0.27683860053273E-03, abs=1E-6)
    assert grad[48, 0] == pytest.approx(0.15098279301011E-04, abs=1E-6)
    assert grad[48, 1] == pytest.approx(0.93557160546381E-03, abs=1E-6)
    assert grad[48, 2] == pytest.approx(-0.33050379082729E-04, abs=1E-6)
    assert grad[49, 0] == pytest.approx(-0.74596918775100E-03, abs=1E-6)
    assert grad[49, 1] == pytest.approx(-0.15043852117657E-03, abs=1E-6)
    assert grad[49, 2] == pytest.approx(0.13005920216928E-03, abs=1E-6)
    assert grad[50, 0] == pytest.approx(-0.56163311595122E-03, abs=1E-6)
    assert grad[50, 1] == pytest.approx(0.62036182589626E-03, abs=1E-6)
    assert grad[50, 2] == pytest.approx(-0.15904402086311E-03, abs=1E-6)
    assert grad[51, 0] == pytest.approx(-0.52961861065490E-03, abs=1E-6)
    assert grad[51, 1] == pytest.approx(0.18542169563333E-03, abs=1E-6)
    assert grad[51, 2] == pytest.approx(0.37920803427412E-03, abs=1E-6)
    assert grad[52, 0] == pytest.approx(0.45461184156401E-03, abs=1E-6)
    assert grad[52, 1] == pytest.approx(0.55633929051552E-03, abs=1E-6)
    assert grad[52, 2] == pytest.approx(-0.44506619795246E-03, abs=1E-6)
    assert grad[53, 0] == pytest.approx(0.33787323145827E-03, abs=1E-6)
    assert grad[53, 1] == pytest.approx(0.51472539709650E-03, abs=1E-6)
    assert grad[53, 2] == pytest.approx(0.17274932015987E-03, abs=1E-6)
    assert grad[54, 0] == pytest.approx(0.45860007196877E-03, abs=1E-6)
    assert grad[54, 1] == pytest.approx(0.41609792638722E-03, abs=1E-6)
    assert grad[54, 2] == pytest.approx(0.66520654768515E-03, abs=1E-6)
    assert grad[55, 0] == pytest.approx(0.26602599269625E-03, abs=1E-6)
    assert grad[55, 1] == pytest.approx(-0.51313466515424E-03, abs=1E-6)
    assert grad[55, 2] == pytest.approx(0.60562121870499E-05, abs=1E-6)
    assert grad[56, 0] == pytest.approx(0.33776188964159E-03, abs=1E-6)
    assert grad[56, 1] == pytest.approx(-0.77598266465638E-04, abs=1E-6)
    assert grad[56, 2] == pytest.approx(0.54284619083235E-03, abs=1E-6)
    assert grad[57, 0] == pytest.approx(0.59816288304327E-03, abs=1E-6)
    assert grad[57, 1] == pytest.approx(0.50024928219000E-04, abs=1E-6)
    assert grad[57, 2] == pytest.approx(-0.23037303670062E-03, abs=1E-6)
    assert grad[58, 0] == pytest.approx(0.32585862194356E-03, abs=1E-6)
    assert grad[58, 1] == pytest.approx(0.38022784558631E-04, abs=1E-6)
    assert grad[58, 2] == pytest.approx(-0.29996961476651E-03, abs=1E-6)
    assert grad[59, 0] == pytest.approx(0.32601971990793E-03, abs=1E-6)
    assert grad[59, 1] == pytest.approx(0.39677021961920E-04, abs=1E-6)
    assert grad[59, 2] == pytest.approx(-0.10822338015477E-03, abs=1E-6)
    assert grad[60, 0] == pytest.approx(0.35879238987349E-03, abs=1E-6)
    assert grad[60, 1] == pytest.approx(0.13551136441295E-03, abs=1E-6)
    assert grad[60, 2] == pytest.approx(-0.14024983294786E-03, abs=1E-6)
    assert grad[61, 0] == pytest.approx(0.78913900690811E-04, abs=1E-6)
    assert grad[61, 1] == pytest.approx(-0.82239511390362E-04, abs=1E-6)
    assert grad[61, 2] == pytest.approx(0.43168740640081E-03, abs=1E-6)
    assert grad[62, 0] == pytest.approx(0.19101918722848E-03, abs=1E-6)
    assert grad[62, 1] == pytest.approx(0.54270232450281E-04, abs=1E-6)
    assert grad[62, 2] == pytest.approx(0.35754976768672E-03, abs=1E-6)
    assert grad[63, 0] == pytest.approx(0.19024119042316E-03, abs=1E-6)
    assert grad[63, 1] == pytest.approx(-0.25233440737570E-04, abs=1E-6)
    assert grad[63, 2] == pytest.approx(0.28806297248064E-03, abs=1E-6)
    assert grad[64, 0] == pytest.approx(0.60264802794365E-04, abs=1E-6)
    assert grad[64, 1] == pytest.approx(-0.36224162920476E-03, abs=1E-6)
    assert grad[64, 2] == pytest.approx(0.84571549113634E-04, abs=1E-6)
    assert grad[65, 0] == pytest.approx(0.18434142585794E-03, abs=1E-6)
    assert grad[65, 1] == pytest.approx(-0.28307699026813E-03, abs=1E-6)
    assert grad[65, 2] == pytest.approx(0.17970762842745E-04, abs=1E-6)
    assert grad[66, 0] == pytest.approx(0.13334669353749E-03, abs=1E-6)
    assert grad[66, 1] == pytest.approx(-0.32579829125995E-03, abs=1E-6)
    assert grad[66, 2] == pytest.approx(-0.13142082595504E-03, abs=1E-6)
    assert grad[67, 0] == pytest.approx(0.26589910462975E-03, abs=1E-6)
    assert grad[67, 1] == pytest.approx(0.29825079606157E-03, abs=1E-6)
    assert grad[67, 2] == pytest.approx(-0.83844867563783E-06, abs=1E-6)
    assert grad[68, 0] == pytest.approx(0.19668146944048E-03, abs=1E-6)
    assert grad[68, 1] == pytest.approx(0.26369449476365E-03, abs=1E-6)
    assert grad[68, 2] == pytest.approx(0.23007932591959E-03, abs=1E-6)
    assert grad[69, 0] == pytest.approx(0.18054354511797E-03, abs=1E-6)
    assert grad[69, 1] == pytest.approx(0.30140694652346E-03, abs=1E-6)
    assert grad[69, 2] == pytest.approx(0.98524356642812E-04, abs=1E-6)
    assert grad[70, 0] == pytest.approx(0.15185299270785E-03, abs=1E-6)
    assert grad[70, 1] == pytest.approx(0.17686093322150E-03, abs=1E-6)
    assert grad[70, 2] == pytest.approx(0.38892532177029E-03, abs=1E-6)
    assert grad[71, 0] == pytest.approx(0.13118875300895E-03, abs=1E-6)
    assert grad[71, 1] == pytest.approx(0.24816912225637E-03, abs=1E-6)
    assert grad[71, 2] == pytest.approx(0.31474219006162E-03, abs=1E-6)
    assert grad[72, 0] == pytest.approx(-0.15907200387641E-04, abs=1E-6)
    assert grad[72, 1] == pytest.approx(0.15775248385612E-03, abs=1E-6)
    assert grad[72, 2] == pytest.approx(0.46390635013370E-03, abs=1E-6)
    assert grad[73, 0] == pytest.approx(0.12410706381361E-03, abs=1E-6)
    assert grad[73, 1] == pytest.approx(0.27801961361957E-03, abs=1E-6)
    assert grad[73, 2] == pytest.approx(-0.37956026266356E-03, abs=1E-6)
    assert grad[74, 0] == pytest.approx(0.15536870511466E-03, abs=1E-6)
    assert grad[74, 1] == pytest.approx(0.31081958097902E-03, abs=1E-6)
    assert grad[74, 2] == pytest.approx(-0.22520009108406E-03, abs=1E-6)
    assert grad[75, 0] == pytest.approx(0.22553389367182E-03, abs=1E-6)
    assert grad[75, 1] == pytest.approx(0.28403908870781E-03, abs=1E-6)
    assert grad[75, 2] == pytest.approx(-0.35359755813599E-03, abs=1E-6)
    assert grad[76, 0] == pytest.approx(-0.26709033471120E-04, abs=1E-6)
    assert grad[76, 1] == pytest.approx(0.33156227434239E-04, abs=1E-6)
    assert grad[76, 2] == pytest.approx(0.50128430976318E-03, abs=1E-6)
    assert grad[77, 0] == pytest.approx(-0.13543120685153E-04, abs=1E-6)
    assert grad[77, 1] == pytest.approx(0.14863476663695E-03, abs=1E-6)
    assert grad[77, 2] == pytest.approx(0.39296429101396E-03, abs=1E-6)
    assert grad[78, 0] == pytest.approx(-0.89411760863278E-04, abs=1E-6)
    assert grad[78, 1] == pytest.approx(0.12904042028123E-03, abs=1E-6)
    assert grad[78, 2] == pytest.approx(0.49944343279991E-03, abs=1E-6)
    assert grad[79, 0] == pytest.approx(-0.91312923565871E-04, abs=1E-6)
    assert grad[79, 1] == pytest.approx(0.31995395621708E-03, abs=1E-6)
    assert grad[79, 2] == pytest.approx(0.24146123718862E-03, abs=1E-6)
    assert grad[80, 0] == pytest.approx(-0.38892178776850E-04, abs=1E-6)
    assert grad[80, 1] == pytest.approx(0.42422610641330E-03, abs=1E-6)
    assert grad[80, 2] == pytest.approx(0.44633624864199E-04, abs=1E-6)
    assert grad[81, 0] == pytest.approx(-0.10146706587217E-04, abs=1E-6)
    assert grad[81, 1] == pytest.approx(0.34233497328127E-03, abs=1E-6)
    assert grad[81, 2] == pytest.approx(0.14537167440825E-03, abs=1E-6)
    assert grad[82, 0] == pytest.approx(0.83923850939089E-04, abs=1E-6)
    assert grad[82, 1] == pytest.approx(0.41254213764112E-03, abs=1E-6)
    assert grad[82, 2] == pytest.approx(-0.13343409534023E-03, abs=1E-6)
    assert grad[83, 0] == pytest.approx(0.63429865879225E-04, abs=1E-6)
    assert grad[83, 1] == pytest.approx(0.42134421312684E-03, abs=1E-6)
    assert grad[83, 2] == pytest.approx(-0.66066235703115E-04, abs=1E-6)
    assert grad[84, 0] == pytest.approx(0.21639173723381E-03, abs=1E-6)
    assert grad[84, 1] == pytest.approx(0.44425440716771E-03, abs=1E-6)
    assert grad[84, 2] == pytest.approx(-0.17153760810181E-03, abs=1E-6)
    assert grad[85, 0] == pytest.approx(-0.47239903952091E-03, abs=1E-6)
    assert grad[85, 1] == pytest.approx(-0.10910430897498E-03, abs=1E-6)
    assert grad[85, 2] == pytest.approx(-0.29337628381223E-05, abs=1E-6)
    assert grad[86, 0] == pytest.approx(-0.35234931501245E-03, abs=1E-6)
    assert grad[86, 1] == pytest.approx(-0.91829422436281E-04, abs=1E-6)
    assert grad[86, 2] == pytest.approx(-0.66828818369931E-04, abs=1E-6)
    assert grad[87, 0] == pytest.approx(-0.33727131045948E-03, abs=1E-6)
    assert grad[87, 1] == pytest.approx(-0.23679821421978E-03, abs=1E-6)
    assert grad[87, 2] == pytest.approx(0.53051597627155E-04, abs=1E-6)
    assert grad[88, 0] == pytest.approx(-0.29195427463737E-03, abs=1E-6)
    assert grad[88, 1] == pytest.approx(0.94017979959145E-05, abs=1E-6)
    assert grad[88, 2] == pytest.approx(0.35418239748718E-03, abs=1E-6)
    assert grad[89, 0] == pytest.approx(-0.27738181806893E-03, abs=1E-6)
    assert grad[89, 1] == pytest.approx(0.11558385118043E-03, abs=1E-6)
    assert grad[89, 2] == pytest.approx(0.19105171156565E-03, abs=1E-6)
    assert grad[90, 0] == pytest.approx(-0.26597241073913E-03, abs=1E-6)
    assert grad[90, 1] == pytest.approx(0.18602452177111E-03, abs=1E-6)
    assert grad[90, 2] == pytest.approx(0.26725018437871E-03, abs=1E-6)
    assert grad[91, 0] == pytest.approx(-0.29291455746557E-03, abs=1E-6)
    assert grad[91, 1] == pytest.approx(0.41280482664878E-03, abs=1E-6)
    assert grad[91, 2] == pytest.approx(-0.25224026199748E-03, abs=1E-6)
    assert grad[92, 0] == pytest.approx(-0.17583426496709E-03, abs=1E-6)
    assert grad[92, 1] == pytest.approx(0.39209949154896E-03, abs=1E-6)
    assert grad[92, 2] == pytest.approx(-0.16327253505943E-03, abs=1E-6)
    assert grad[93, 0] == pytest.approx(-0.20555563092932E-03, abs=1E-6)
    assert grad[93, 1] == pytest.approx(0.26198237489625E-03, abs=1E-6)
    assert grad[93, 2] == pytest.approx(-0.17548691016592E-03, abs=1E-6)
    assert grad[94, 0] == pytest.approx(0.61658483434154E-03, abs=1E-6)
    assert grad[94, 1] == pytest.approx(0.11514427144400E-03, abs=1E-6)
    assert grad[94, 2] == pytest.approx(-0.74762955235450E-03, abs=1E-6)
    assert grad[95, 0] == pytest.approx(0.34934780555561E-03, abs=1E-6)
    assert grad[95, 1] == pytest.approx(0.61832486905442E-03, abs=1E-6)
    assert grad[95, 2] == pytest.approx(-0.14419018569281E-02, abs=1E-6)
    assert grad[96, 0] == pytest.approx(0.52233964664844E-03, abs=1E-6)
    assert grad[96, 1] == pytest.approx(0.83293342123291E-03, abs=1E-6)
    assert grad[96, 2] == pytest.approx(-0.14946783779889E-02, abs=1E-6)
    assert grad[97, 0] == pytest.approx(0.27033204654944E-04, abs=1E-6)
    assert grad[97, 1] == pytest.approx(-0.32648421936354E-04, abs=1E-6)
    assert grad[97, 2] == pytest.approx(-0.13636735773680E-02, abs=1E-6)
    assert grad[98, 0] == pytest.approx(0.12670444968729E-03, abs=1E-6)
    assert grad[98, 1] == pytest.approx(0.28787781998577E-03, abs=1E-6)
    assert grad[98, 2] == pytest.approx(-0.42574282950018E-03, abs=1E-6)
    assert grad[99, 0] == pytest.approx(0.26148472507445E-03, abs=1E-6)
    assert grad[99, 1] == pytest.approx(0.27654293893619E-03, abs=1E-6)
    assert grad[99, 2] == pytest.approx(-0.52847207556216E-03, abs=1E-6)
    assert grad[100, 0] == pytest.approx(0.17220965745413E-03, abs=1E-6)
    assert grad[100, 1] == pytest.approx(0.30755723619206E-03, abs=1E-6)
    assert grad[100, 2] == pytest.approx(-0.46063939191557E-03, abs=1E-6)
    assert grad[101, 0] == pytest.approx(-0.25633475152967E-03, abs=1E-6)
    assert grad[101, 1] == pytest.approx(-0.56647960951220E-04, abs=1E-6)
    assert grad[101, 2] == pytest.approx(-0.14994478117036E-02, abs=1E-6)
    assert grad[102, 0] == pytest.approx(-0.49308591589684E-04, abs=1E-6)
    assert grad[102, 1] == pytest.approx(-0.29400572566996E-03, abs=1E-6)
    assert grad[102, 2] == pytest.approx(-0.10926886700604E-02, abs=1E-6)
    assert grad[103, 0] == pytest.approx(-0.31729832680110E-03, abs=1E-6)
    assert grad[103, 1] == pytest.approx(-0.25500474248704E-03, abs=1E-6)
    assert grad[103, 2] == pytest.approx(-0.11837421975995E-02, abs=1E-6)
    assert grad[104, 0] == pytest.approx(0.19690199139478E-03, abs=1E-6)
    assert grad[104, 1] == pytest.approx(0.36108730700931E-05, abs=1E-6)
    assert grad[104, 2] == pytest.approx(-0.55156486417443E-03, abs=1E-6)
    assert grad[105, 0] == pytest.approx(-0.24913241272391E-03, abs=1E-6)
    assert grad[105, 1] == pytest.approx(-0.20418058626915E-03, abs=1E-6)
    assert grad[105, 2] == pytest.approx(-0.62158542390943E-03, abs=1E-6)
    assert grad[106, 0] == pytest.approx(-0.16343865228969E-05, abs=1E-6)
    assert grad[106, 1] == pytest.approx(-0.16049067415988E-03, abs=1E-6)
    assert grad[106, 2] == pytest.approx(-0.44008392762235E-03, abs=1E-6)
    assert grad[107, 0] == pytest.approx(-0.25061858982336E-03, abs=1E-6)
    assert grad[107, 1] == pytest.approx(-0.34655531597798E-03, abs=1E-6)
    assert grad[107, 2] == pytest.approx(-0.66916344366619E-03, abs=1E-6)
    assert grad[108, 0] == pytest.approx(-0.16787714792676E-03, abs=1E-6)
    assert grad[108, 1] == pytest.approx(0.56172804374167E-04, abs=1E-6)
    assert grad[108, 2] == pytest.approx(-0.42315188768987E-03, abs=1E-6)
    assert grad[109, 0] == pytest.approx(-0.13468544259881E-03, abs=1E-6)
    assert grad[109, 1] == pytest.approx(-0.21305845759471E-03, abs=1E-6)
    assert grad[109, 2] == pytest.approx(-0.15482907190840E-03, abs=1E-6)
    assert grad[110, 0] == pytest.approx(-0.23573775182983E-03, abs=1E-6)
    assert grad[110, 1] == pytest.approx(-0.94354164089405E-04, abs=1E-6)
    assert grad[110, 2] == pytest.approx(-0.18100341338633E-03, abs=1E-6)
